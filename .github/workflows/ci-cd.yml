name: CI/CD Pipeline

on:
  push:
    branches:
      - main

permissions:
  contents: read

jobs:
  build-and-push:
    name: Build and Push Docker Images
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # Build & push images cho tất cả service
      - name: Build & Push all service images
        run: |
          # api-gateway
          docker build -t trinhvanvu/api-gateway:latest -t trinhvanvu/api-gateway:${{ github.sha }} ./api-gateway
          docker push trinhvanvu/api-gateway:latest
          docker push trinhvanvu/api-gateway:${{ github.sha }}

          # auth
          docker build -t trinhvanvu/auth:latest -t trinhvanvu/auth:${{ github.sha }} ./auth
          docker push trinhvanvu/auth:latest
          docker push trinhvanvu/auth:${{ github.sha }}

          # order
          docker build -t trinhvanvu/order:latest -t trinhvanvu/order:${{ github.sha }} ./order
          docker push trinhvanvu/order:latest
          docker push trinhvanvu/order:${{ github.sha }}

          # product
          docker build -t trinhvanvu/product:latest -t trinhvanvu/product:${{ github.sha }} ./product
          docker push trinhvanvu/product:latest
          docker push trinhvanvu/product:${{ github.sha }}

  deploy:
    name: Deploy on Localhost (Docker Desktop)
    needs: build-and-push
    runs-on: self-hosted

    steps:
      - name: Deploy with Docker Compose
        run: |
          cd "D:\DAIHOC\NAM4\TAILIEU\LTHDV\THUCHANH\22685821-TrinhVanVu-EProject1\22685821-TrinhVanVu-EProject-main"
          docker-compose down --remove-orphans
          docker-compose pull
          docker-compose up -d
