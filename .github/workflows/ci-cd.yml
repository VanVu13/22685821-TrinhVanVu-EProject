name: Build, Push and Deploy Docker Images

on:
  push:
    branches:
      - main

jobs:
  build-and-push:
    runs-on: self-hosted   # GitHub runner để build & push
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Login Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # Build & push Docker images cho tất cả service
      - name: Build & Push api-gateway
        run: |
          docker build -t trinhvanvu/api-gateway:latest -t trinhvanvu/api-gateway:${{ github.sha }} ./api-gateway
          docker push trinhvanvu/api-gateway:latest
          docker push trinhvanvu/api-gateway:${{ github.sha }}

      - name: Build & Push auth
        run: |
          docker build -t trinhvanvu/auth:latest -t trinhvanvu/auth:${{ github.sha }} ./auth
          docker push trinhvanvu/auth:latest
          docker push trinhvanvu/auth:${{ github.sha }}

      - name: Build & Push order
        run: |
          docker build -t trinhvanvu/order:latest -t trinhvanvu/order:${{ github.sha }} ./order
          docker push trinhvanvu/order:latest
          docker push trinhvanvu/order:${{ github.sha }}

      - name: Build & Push product
        run: |
          docker build -t trinhvanvu/product:latest -t trinhvanvu/product:${{ github.sha }} ./product
          docker push trinhvanvu/product:latest
          docker push trinhvanvu/product:${{ github.sha }}

  deploy:
    name: Deploy on Localhost (Windows Runner)
    runs-on: self-hosted    # Self-hosted runner trên Windows
    needs: build-and-push
    steps:
      - name: Pull latest Docker images
        run: |
          docker pull trinhvanvu/api-gateway:latest
          docker pull trinhvanvu/auth:latest
          docker pull trinhvanvu/order:latest
          docker pull trinhvanvu/product:latest

      - name: Deploy with Docker Compose
        run: |
          cd "D:\DAIHOC\NAM4\TAILIEU\LTHDV\THUCHANH\22685821-TrinhVanVu-EProject-main\22685821-TrinhVanVu-EProject-main"
          docker-compose down --remove-orphans
          docker-compose pull
          docker-compose up -d --force-recreate

