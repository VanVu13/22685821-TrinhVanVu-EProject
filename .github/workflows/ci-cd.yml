name: Build, Push and Deploy Docker Images

on:
  push:
    branches:
      - main

jobs:
  build-push-deploy:
    runs-on: self-hosted   # Self-hosted runner = Docker Desktop
    steps:
      # 1. Checkout code
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. Login Docker Hub
      - name: Login Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 3. Build all service images locally & tag commit
      - name: Build all service images
        run: |
          docker build -t trinhvanvu/api-gateway:latest ./api-gateway
          docker build -t trinhvanvu/api-gateway:${{ github.sha }} ./api-gateway

          docker build -t trinhvanvu/auth:latest ./auth
          docker build -t trinhvanvu/auth:${{ github.sha }} ./auth

          docker build -t trinhvanvu/order:latest ./order
          docker build -t trinhvanvu/order:${{ github.sha }} ./order

          docker build -t trinhvanvu/product:latest ./product
          docker build -t trinhvanvu/product:${{ github.sha }} ./product

      # 4. Push images to Docker Hub (backup)
      - name: Push images to Docker Hub
        run: |
          docker push trinhvanvu/api-gateway:latest
          docker push trinhvanvu/api-gateway:${{ github.sha }}

          docker push trinhvanvu/auth:latest
          docker push trinhvanvu/auth:${{ github.sha }}

          docker push trinhvanvu/order:latest
          docker push trinhvanvu/order:${{ github.sha }}

          docker push trinhvanvu/product:latest
          docker push trinhvanvu/product:${{ github.sha }}

      # 5. Deploy containers locally
      - name: Deploy with Docker Compose
        run: |
          cd "D:\DAIHOC\NAM4\TAILIEU\LTHDV\THUCHANH\22685821-TrinhVanVu-EProject-main\22685821-TrinhVanVu-EProject-main"
          docker-compose up -d
