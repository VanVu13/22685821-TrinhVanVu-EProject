name: Build, Push and Deploy Docker Images

on:
  push:
    branches:
      - main

jobs:
  build-and-push:
    runs-on: ubuntu-latest   # GitHub runner để build & push
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Login Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # Build & push Docker images cho tất cả service
      - name: Build & Push api-gateway
        run: |
          docker build -t trinhvanvu/api-gateway:latest ./api-gateway
          docker push trinhvanvu/api-gateway:latest

      - name: Build & Push auth
        run: |
          docker build -t trinhvanvu/auth:latest ./auth
          docker push trinhvanvu/auth:latest

      - name: Build & Push order
        run: |
          docker build -t trinhvanvu/order:latest ./order
          docker push trinhvanvu/order:latest

      - name: Build & Push product
        run: |
          docker build -t trinhvanvu/product:latest ./product
          docker push trinhvanvu/product:latest

  deploy:
    name: Deploy on Localhost (Windows Runner)
    runs-on: self-hosted    # Self-hosted runner trên Windows
    needs: build-and-push
    steps:
      - name: Pull latest Docker images
        run: |
          docker pull trinhvanvu/api-gateway:latest
          docker pull trinhvanvu/auth:latest
          docker pull trinhvanvu/order:latest
          docker pull trinhvanvu/product:latest

      - name: Deploy with Docker Compose
        run: |
          cd "D:\DAIHOC\NAM4\TAILIEU\LTHDV\THUCHANH\22685821-TrinhVanVu-EProject-main\22685821-TrinhVanVu-EProject-main"
          docker-compose up -d
